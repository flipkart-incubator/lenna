#! /bin/bash -e
#Package Configuration
PACKAGE=rukmini
PACKAGE_USER=rukmini
PACKAGE_GROUP=rukmini
PF_UID=9075
PF_GID=9001

if [ "$1" == "configure" ] ; then
    #Creating group if it doesnt exist
    if ! getent group ${PACKAGE_GROUP} > /dev/null; then
        groupadd -g "${PF_GID}" ${PACKAGE_GROUP}
    fi
    #Creating user if it doesnt exist
    if ! getent passwd ${PF_UID} > /dev/null; then
        adduser --system --uid ${PF_UID} --home /var/lib/${PACKAGE} --no-create-home \
            --ingroup ${PACKAGE_GROUP} --disabled-password --shell /bin/false \
            ${PACKAGE_USER}
    fi
    if ! getent passwd ${PF_UID} > /dev/null; then
        adduser --system --uid ${PF_UID} --home /var/lib/${PACKAGE} --no-create-home \
            --ingroup ${PACKAGE_GROUP} --disabled-password --shell /bin/false \
            ${PACKAGE_USER}
    fi
    chown -R ${PF_UID}:${PF_GID} /var/lib/${PACKAGE}
    if [ -d "/var/log/${PACKAGE}" ]; then
 	    touch /var/log/${PACKAGE}/${PACKAGE}.log
 	else
 	    mkdir -p /var/log/${PACKAGE}
 	    touch /var/log/${PACKAGE}/${PACKAGE}.log
    fi
    chmod -R a+rwx /var/log/${PACKAGE}
    chown -R ${PF_UID}:${PF_GID} /var/log/${PACKAGE}
    chmod a+x /etc/init.d/${PACKAGE}
    chmod -R a+rwx /var/lib/${PACKAGE}/src

    # Compile the binary now (double meh.. tripple meh)
    export PATH=/usr/local/go/bin:$PATH
    export GOPATH=/var/lib/rukmini
    cd /var/lib/rukmini/src/rukmini
    echo "Compiling rukmini service..."
    go build
    echo "Compilation complete!"

    chmod -R a+rwx /var/lib/${PACKAGE}/src/${PACKAGE}/${PACKAGE}

    sudo supervisorctl reload
    sudo supervisorctl stop
    sleep 5
    sudo supervisorctl start
fi
exit 0